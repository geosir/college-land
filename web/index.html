<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unitopia</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>


    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #header {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            padding: 16px;
            text-align: center;
            /*background-color: rgba(255, 255, 255, 0.5);*/
            background-color: rgba(20, 20, 20, 0.7);
            color: white;
            z-index: 1000;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .leaflet-container, .leaflet-interactive {
            cursor: crosshair;
        }

        #info {
            visibility: hidden;
            background-color: rgba(20, 20, 20, 0.7);
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 25vw;
            display: flex;
            z-index: 1000;
        }

        #info-content {
            width: 100%;
            align-self: center;
            padding: 24px;
            color: white;
        }
    </style>


    <script
            src="https://code.jquery.com/jquery-3.4.0.min.js"
            integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
            integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
            crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.2.4/dist/esri-leaflet.js"
            integrity="sha512-tyPum7h2h36X52O2gz+Pe8z/3l+Y9S1yEUscbVs5r5aEY5dFmP1WWRY/WLLElnFHa+k1JBQZSCDGwEAnm2IxAQ=="
            crossorigin=""></script>
</head>
<body>

<!-- Load Leaflet Label from GitHub -->
<script src="https://leaflet.github.io/Leaflet.label/leaflet.label.js"></script>

<!-- Load Esri Leaflet Renderers from CDN -->
<script src="http://cdn.jsdelivr.net/leaflet.esri.renderers/2.0.2/esri-leaflet-renderers.js"></script>

<!-- Load Vector Icon from GitHub -->
<script src="https://muxlab.github.io/Leaflet.VectorIcon/L.VectorIcon.js"></script>

<!-- Load Leaflet Omnivore -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

<!-- Load L.esri.WebMap -->
<script src="https://cdn.jsdelivr.net/leaflet.esri.webmap/0.4.0/esri-leaflet-webmap.js"></script>

<div id="header"><h1>Unitopia</h1></div>
<div id="map"></div>
<div id="info">
    <div id="info-content" data-xy="">
        <h1>Parcel Info</h1>
        <p><b>Owner:</b> <span id="parcel-owner">Test text</span></p>
        <p><b>Land Use:</b> <span id="parcel-use">Test text</span></p>
        <p><b>Assessed Value:</b> <span id="parcel-value">Test text</span></p>
        <button id="parcel-close" class="btn btn-primary">Close</button>
        <button id="parcel-google-maps" class="btn btn-success">Open in Google Maps</button>
    </div>
</div>

<script>

    function swapCoords(coords) {
        return coords.map((c) => [c[1], c[0]])
    }

    const webmapID = '6fda7e2ca6c440e59a20805c563faa60';

    let webmap = L.esri.webMap(webmapID, {
        map: L.map("map", {
            zoomControl: false,
            maxNativeZoom: 16,
            minZoom: 12,
            maxZoom: 18
        })
    });

    webmap.on('load', function () {
        let overlayMaps = {};

        webmap.layers.map(function (l) {
            if (!l.title.includes("World")) overlayMaps[l.title] = l.layer;
            if (l.title.includes("World")) {
                l.layer.options.maxNativeZoom = 16;
            }
        });

        L.control.layers({}, overlayMaps, {
            position: 'bottomleft'
        }).addTo(webmap._map);
    });

    let parcelMarker = null;
    webmap._map.on('click', (e) => {
        $("#info").css({visibility: "visible"});

        console.log("CLICK EVENT", e);

        $("#parcel-owner").text("Loading...");
        $("#parcel-use").text("Loading...");
        $("#parcel-value").text("Loading...");

        // Query Cambridge
        const cambridgeQuery = new Promise((resolve, reject) => {
            L.esri.query({
                url: 'https://services1.arcgis.com/qN3V93cYGMKQCOxL/arcgis/rest/services/Cambridge_Land_Use_2019/FeatureServer/0',
            }).contains(e.latlng).run(function (error, featureCollection) {
                console.log("Cambridge", featureCollection);
                if (featureCollection) {
                    const features = featureCollection.features.filter((f) => f.geometry);
                    if (features.length > 0) {
                        const feature = features[0];
                        const props = feature.properties;
                        $("#parcel-owner").text(props.Owner_s_);
                        $("#parcel-use").text(props.Property_Class);
                        $("#parcel-value").text(props.Assessed_Value);

                        resolve(feature);
                    } else {
                        resolve(0);
                    }
                } else {
                    console.error("FEATURE QUERY ERROR (Cambridge 2019):", error);
                    reject(error);
                }
            });
        });

        // Query Boston
        const bostonQuery = new Promise((resolve, reject) => {
            L.esri.query({
                url: 'https://services1.arcgis.com/qN3V93cYGMKQCOxL/arcgis/rest/services/Boston_Land_Use_2019/FeatureServer/0',
            }).contains(e.latlng).run(function (error, featureCollection) {
                console.log("Boston", featureCollection);
                if (featureCollection) {
                    const features = featureCollection.features.filter((f) => f.geometry);
                    if (features.length > 0) {
                        const feature = features[0];
                        const props = feature.properties;
                        $("#parcel-owner").text(props.OWNER + "; " + props.MAIL_ADDRESSEE);
                        $("#parcel-use").text(props.PTYPE_HUMAN);
                        $("#parcel-value").text("$" + props.AV_TOTAL.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));

                        resolve(feature);
                    } else {
                        resolve(0);
                    }
                } else {
                    console.error("FEATURE QUERY ERROR (Boston 2019):", error);
                    reject(error);
                }
            });
        });

        Promise.all([cambridgeQuery, bostonQuery]).then((result) => {
            const valid = result.filter((e) => e);
            if (valid.length > 0) {
                // console.log(valid);
                $("#info-content").attr("data-xy", e.latlng.lat + "," + e.latlng.lng);

                if (parcelMarker) {
                    webmap._map.removeLayer(parcelMarker);
                }

                parcelMarker = L.polygon(swapCoords(valid[0].geometry.coordinates[0]), {
                    color: 'red',
                    weight: 5
                }).addTo(webmap._map);
                webmap._map.addLayer(parcelMarker);
            } else {
                $("#parcel-owner").text("No data.");
                $("#parcel-use").text("No data.");
                $("#parcel-value").text("No data.");
            }
        })
    });

    $("#parcel-close").click(() => {
        $("#info").css({visibility: "hidden"});
    });

    $("#parcel-google-maps").click(() => {
        window.open("https://www.google.com/maps/@" + $("#info-content").attr("data-xy") + ",200m/data=!3m1!1e3");
    });

</script>

</body>
</html>