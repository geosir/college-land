<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unitopia</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>


    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #header {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            padding: 16px;
            text-align: center;
            /*background-color: rgba(255, 255, 255, 0.5);*/
            background-color: rgba(20, 20, 20, 0.7);
            color: white;
            z-index: 1000;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        #info {
            background-color: rgba(20, 20, 20, 0.7);
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 25vw;
            display: flex;
            z-index: 1000;
        }

        #info-content {
            width: 100%;
            align-self: center;
            padding: 24px;
            color: white;
        }
    </style>


    <script
            src="https://code.jquery.com/jquery-3.4.0.min.js"
            integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
            integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
            crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.2.4/dist/esri-leaflet.js"
            integrity="sha512-tyPum7h2h36X52O2gz+Pe8z/3l+Y9S1yEUscbVs5r5aEY5dFmP1WWRY/WLLElnFHa+k1JBQZSCDGwEAnm2IxAQ=="
            crossorigin=""></script>
</head>
<body>

<!-- Load Leaflet Label from GitHub -->
<script src="https://leaflet.github.io/Leaflet.label/leaflet.label.js"></script>

<!-- Include Leaflet.heat from CDN -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<!-- Load Heatmap Feature Layer from CDN -->
<script src="https://cdn.jsdelivr.net/leaflet.esri.heatmap-feature-layer/2.0.0-beta.1/esri-leaflet-heatmap-feature-layer.js"></script>

<!-- Load Esri Leaflet Renderers from CDN -->
<script src="http://cdn.jsdelivr.net/leaflet.esri.renderers/2.0.2/esri-leaflet-renderers.js"></script>

<!-- Load Vector Icon from GitHub -->
<script src="https://muxlab.github.io/Leaflet.VectorIcon/L.VectorIcon.js"></script>

<!-- Load Leaflet Omnivore -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

<!-- Load L.esri.WebMap -->
<script src="https://cdn.jsdelivr.net/leaflet.esri.webmap/0.4.0/esri-leaflet-webmap.js"></script>

<div id="header"><h1>Unitopia</h1></div>
<div id="map"></div>
<div id="info">
    <div id="info-content">
        <h1>Parcel Info</h1>
        <p><b>Owner:</b> <span id="parcel-owner">Test text</span></p>
        <p><b>Land Use:</b> <span id="parcel-use">Test text</span></p>
        <p><b>Assessed Value:</b> <span id="parcel-value">Test text</span></p>
    </div>
</div>

<script>

    const webmapID = '6fda7e2ca6c440e59a20805c563faa60';

    let webmap = L.esri.webMap(webmapID, {
        map: L.map("map", {
            zoomControl: false,
            minZoom: 12,
            maxZoom: 16
        })
    });

    webmap.on('load', function () {
        let overlayMaps = {};

        webmap.layers.map(function (l) {
            if (!l.title.includes("World")) overlayMaps[l.title] = l.layer;

            if (l.layer.eachLayer) {
                l.layer.eachLayer((l) => {
                    l.on('click', (e) => {
                        const props = e.sourceTarget.feature.properties;
                        if (props.ML) {
                            $("#parcel-owner").text(props.Owner_s_);
                            $("#parcel-use").text(props.Property_Class);
                            $("#parcel-value").text(props.Assessed_Value);
                        } else if (props.WPD) {
                            $("#parcel-owner").text(props.OWNER);
                            $("#parcel-use").text(props.PTYPE_HUMAN);
                            $("#parcel-value").text(props.AV_TOTAL);
                        }
                    });
                });
            } else if (!l.title.includes("World")) {
                console.log("TILE LAYER", l.layer);
                webmap._map.on('click', (e) => {
                    console.log("CLICK EVENT", e);

                    L.esri.query({
                        url: 'https://services1.arcgis.com/qN3V93cYGMKQCOxL/arcgis/rest/services/Cambridge_Land_Use_2019/FeatureServer/0',
                    }).nearby(e.latlng, 0).run(function (error, featureCollection, response) {
                        // console.log("ERR", error);
                        // console.log("FEA", featureCollection);
                        // console.log("RES", response)
                        if (featureCollection.features.length > 0) {
                            props = featureCollection.features[0].properties;
                            if (props.ML) {
                                $("#parcel-owner").text(props.Owner_s_);
                                $("#parcel-use").text(props.Property_Class);
                                $("#parcel-value").text(props.Assessed_Value);
                            } else if (props.WPD) {
                                $("#parcel-owner").text(props.OWNER);
                                $("#parcel-use").text(props.PTYPE_HUMAN);
                                $("#parcel-value").text(props.AV_TOTAL);
                            }
                        }
                    });
                });

            }
        });

        L.control.layers({}, overlayMaps, {
            position: 'bottomleft'
        }).addTo(webmap._map);
    });
</script>

</body>
</html>